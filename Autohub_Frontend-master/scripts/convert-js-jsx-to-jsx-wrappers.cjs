/* eslint-disable no-console */
const fs = require('fs');
const path = require('path');

const ROOT = path.resolve(__dirname, '..');
const SRC = path.join(ROOT, 'src');

function walk(dir) {
	const entries = fs.readdirSync(dir, { withFileTypes: true });
	const out = [];
	for (const e of entries) {
		const full = path.join(dir, e.name);
		if (e.isDirectory()) out.push(...walk(full));
		else out.push(full);
	}
	return out;
}

function hasLikelyJsx(code) {
	// Heuristic: React import + JSX tag
	const hasReactImport =
		/from\s+['"]react['"]/.test(code) ||
		/require\(\s*['"]react['"]\s*\)/.test(code);
	const looksLikeComponentReturn = /\breturn\s*</.test(code) || /\breturn\s*\(/.test(code);
	const hasJsxTag =
		/<[A-Za-z][A-Za-z0-9:_-]*[\s/>]/.test(code) ||
		/<\/[A-Za-z][A-Za-z0-9:_-]*>/.test(code) ||
		/<>/.test(code);
	return hasJsxTag && (hasReactImport || looksLikeComponentReturn);
}

function toPosix(p) {
	return p.split(path.sep).join('/');
}

const files = walk(SRC).filter((f) => f.endsWith('.js'));
let converted = 0;

for (const file of files) {
	const code = fs.readFileSync(file, 'utf8');
	if (!hasLikelyJsx(code)) continue;

	const jsxFile = file.replace(/\.js$/, '.jsx');
	if (fs.existsSync(jsxFile)) continue;

	// Write the original implementation into .jsx
	fs.writeFileSync(jsxFile, code, 'utf8');

	// Replace .js with a re-export wrapper (no JSX)
	const hasDefaultExport = /\bexport\s+default\b/.test(code);
	const baseName = path.basename(jsxFile);
	const wrapperLines = [
		'// Auto-generated by scripts/convert-js-jsx-to-jsx-wrappers.cjs',
		`export * from './${baseName}';`,
		hasDefaultExport ? `export { default } from './${baseName}';` : '',
		'',
	].filter(Boolean);
	fs.writeFileSync(file, wrapperLines.join('\n'), 'utf8');

	converted += 1;
}

console.log(`Converted ${converted} files to .jsx + wrapper .js`);
console.log(`Scanned ${files.length} .js files under ${toPosix(SRC)}`);

